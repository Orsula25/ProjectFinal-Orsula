{% extends 'base.html.twig' %}

{% block titre %}Produits ‚Äî Logix G-Stock{% endblock %}

{% block contenu %}

  <h1 class="mb-4">üì¶ Liste des produits</h1>

  {# Barre de recherche simple + autocompl√©tion #}
  <form id="produit-search-form"
        method="get"
        action="{{ path('app_produit_index') }}"
        class="search-pill mb-3">

    <input
      type="text"
      name="q"
      value="{{ q ?? '' }}"
      class="search-pill-input"
      placeholder="Rechercher par nom, r√©f√©rence, rupture ou sous-seuil..."
      list="produit-terms"
    >

    <button class="search-pill-btn" type="submit" aria-label="Rechercher">
      <i class="fa-solid fa-magnifying-glass"></i>
    </button>

  </form>

  {# Autocompl√©tion (noms + r√©f√©rences) #}
  <datalist id="produit-terms">
    {% for t in termes %}
      {% if t.nom is defined and t.nom %}
        <option value="{{ t.nom }}"></option>
      {% endif %}
      {% if t.reference is defined and t.reference %}
        <option value="{{ t.reference }}"></option>
      {% endif %}
    {% endfor %}
  </datalist>

  <a class="btn btn-success btn-sm produit-add-btn"
     href="{{ path('app_produit_new') }}">
    ‚ûï Ajouter un produit
  </a>

  {% if q is defined and q %}
    <p class="text-muted mb-2">
      R√©sultats pour : <strong>{{ q }}</strong>
    </p>
  {% endif %}

  {# Zone remplac√©e en AJAX #}
  <div id="produit-table-wrapper">
    {% include 'produit/_liste.html.twig' %}
  </div>

  <a class="btn btn-outline-secondary ms-2" href="{{ path('app_accueil') }}">
    üè† Retour √† l'accueil
  </a>

{% endblock %}

{% block javascripts %}
  {{ parent() }}

  <script>
    const baseUrl     = '{{ path('app_produit_index') }}';
    const searchForm  = document.getElementById('produit-search-form');
    const searchInput = document.querySelector('#produit-search-form input[name="q"]');
    const wrapper     = document.getElementById('produit-table-wrapper');

    {# Emp√™cher rechargement de la page lors d‚Äôun submit #}
    if (searchForm) {
      searchForm.addEventListener('submit', function (e) {
        e.preventDefault();
      });
    }

    {# Fabrique la query string ?q=...&page=... #}
    function buildQuery(page = 1) {
      const params = new URLSearchParams();
      if (searchInput && searchInput.value.trim() !== '') {
        params.set('q', searchInput.value.trim());
      }
      params.set('page', page);
      return '?' + params.toString();
    }

    {# Charge la liste en AJAX #}
    function loadProduits(queryString) {
      fetch(baseUrl + queryString, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
      .then(r => r.text())
      .then(html => {
        wrapper.innerHTML = html;
        bindPagination();
        bindRowClick();
      });
    }

    {# Recherche en direct #}
    if (searchInput) {
      searchInput.addEventListener('input', function () {
        loadProduits(buildQuery(1));
      });
    }

    {# Pagination en AJAX #}
    function bindPagination() {
      wrapper.querySelectorAll('.js-page').forEach(link => {
        link.addEventListener('click', function (e) {
          e.preventDefault();
          const href = this.getAttribute('href');
          loadProduits(href);
        });
      });
    }

    {# Clic sur une ligne de tableau #}
    function bindRowClick() {
      wrapper.querySelectorAll('.row-click').forEach(row => {
        row.addEventListener('click', function () {
          const url = this.dataset.href;
          if (url) window.location.href = url;
        });
      });
    }

    {# Initialisation #}
    bindPagination();
    bindRowClick();
  </script>

{% endblock %}
