{% extends 'base.html.twig' %}

{% block titre %}Produits â€” Logix G-Stock{% endblock %}

{% block contenu %}
<h1 class="mb-4">ğŸ“¦ Liste des produits</h1>

{# barre de recherche #}
<form id="produit-search-form"
      method="get"
      action="{{ path('app_produit_index') }}"
      class="search-pill mb-3">

  <input
    type="text"
    name="q"
    value="{{ q ?? '' }}"
    class="search-pill-input"
    placeholder="Rechercher par nom ou rÃ©fÃ©rence..."
  >

  <button class="search-pill-btn" type="submit" aria-label="Rechercher">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
</form>

 <a class="btn btn-success btn-sm produit-add-btn"
     href="{{ path('app_produit_new') }}">
    â• Ajouter un produit
  </a>


{% if q is defined and q %}
  <p class="text-muted mb-2">RÃ©sultats pour : <strong>{{ q }}</strong></p>
{% endif %}

{# liste des produits #}
<div id="produit-table-wrapper">
  {% include 'produit/_liste.html.twig' %}
</div>


<a class="btn btn-outiline-secondary ms-2" href="{{path('app_accueil')}}">ğŸ Retour Ã  l'accueil</a>



{% endblock %}
{# Ajax #}
{% block javascripts %}
  {{ parent() }}
  <script>

  document.getElementById('produit-search-form').addEventListener('submit', function (e) {
  e.preventDefault();
})
     // empÃªcher le submit classique (rechargement)
    const searchForm = document.getElementById('produit-search-form');
    if (searchForm) {
      searchForm.addEventListener('submit', function (e) {
        e.preventDefault();
      });
    }

    const searchInput = document.querySelector('#produit-search-form input[name="q"]');
    const wrapper = document.getElementById('produit-table-wrapper');

    if (searchInput) {
  searchInput.addEventListener('input', function () {
    const q = this.value;
    const sort = sortSelect ? sortSelect.value : 'recent';
    loadProduits('?q=' + encodeURIComponent(q) + '&sort=' + encodeURIComponent(sort) + '&page=1');
  });
}

if (sortSelect) {
  sortSelect.addEventListener('change', function () {
    const q = searchInput ? searchInput.value : '';
    const sort = this.value;
    loadProduits('?q=' + encodeURIComponent(q) + '&sort=' + encodeURIComponent(sort) + '&page=1');
  });
}

    
    // charge la liste en AJAX
    function loadProduits(queryString) {
      fetch('{{ path('app_produit_index') }}' + queryString, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(r => r.text())
      .then(html => {
        wrapper.innerHTML = html;
        bindPagination();
        bindRowClick();
      });
    }

    // recherche en direct
    if (searchInput) {
      searchInput.addEventListener('input', function () {
        const q = this.value;
        loadProduits('?q=' + encodeURIComponent(q) + '&page=1');
      });
    }

    // pagination AJAX
    function bindPagination() {
      wrapper.querySelectorAll('.js-page').forEach(link => {
        link.addEventListener('click', function (e) {
          e.preventDefault();
          const href = this.getAttribute('href');
          loadProduits(href);
        });
      });
    }

    // clic sur la ligne
    function bindRowClick() {
      wrapper.querySelectorAll('.row-click').forEach(row => {
        row.addEventListener('click', function () {
          const url = this.dataset.href;
          if (url) window.location.href = url;
        });
      });
    }

    // premier branchement au chargement initial
    bindPagination();
    bindRowClick();
  </script>

  {% endblock %}
