{% extends 'base.html.twig' %}

{% block titre %}Commandes d'achat{% endblock %}

{% block contenu %}

<h1>Commandes d'achat</h1>

<div class="mb-3">
    <a class="btn btn-sm btn-primary" href="{{ path('app_commande_achat_new') }}">
        ➕ Nouvelle commande
    </a>
</div>

<table class="table table-striped align-middle">
    <thead>
        <tr>
            <th>Référence</th>
            <th>Fournisseur</th>
            <th>Date</th>
            <th>Statut</th>
            <th style="width:220px;">Actions</th>
        </tr>
    </thead>
    <tbody>
    {% for c in commandes %}
        <tr>
            <td>{{ c.reference }}</td>
            <td>{{ c.fournisseur.nom }}</td>
            <td>{{ c.date ? c.date|date('d/m/Y H:i') : '—' }}</td>
            <td>
                {% if c.isBrouillon %}
                    <span class="badge bg-secondary">Brouillon</span>
                {% elseif c.isEnvoyee %}
                    <span class="badge bg-info text-dark">Envoyée</span>
                {% elseif c.isReceptionnee %}
                    <span class="badge bg-success">Réceptionnée</span>
                {% elseif c.isAnnulee %}
                    <span class="badge bg-danger">Annulée</span>
                {% else %}
                    <span class="badge bg-light text-dark">{{ c.statut }}</span>
                {% endif %}
            </td>
  <td>
  <div class="commande-actions">

    {# Voir : toujours affiché #}
    <a href="{{ path('app_commande_achat_show', {id: c.id}) }}"
       class="action-btn action-view"
       title="Voir la commande">
      <i class="fa-solid fa-eye"></i>
    </a>

    {# Réceptionner si envoyée #}
    {% if c.isEnvoyee %}
      <form method="post"
            action="{{ path('app_commande_achat_reception', {id: c.id}) }}"
            class="action-form"
            onsubmit="return confirm('Confirmer la réception ? Le stock va être ajouté.');">
        <input type="hidden" name="_token" value="{{ csrf_token('reception' ~ c.id) }}">
        <button type="submit" class="action-btn action-ok" title="Réceptionner">
          <i class="fa-solid fa-check"></i>
        </button>
      </form>
    {% endif %}

    {# Annuler si brouillon OU envoyée (mais pas déjà réceptionnée) #}
    {% if (c.isBrouillon or c.isEnvoyee) and not c.isReceptionnee %}
      <form method="post"
            action="{{ path('app_commande_achat_annuler', {id: c.id}) }}"
            class="action-form"
            onsubmit="return confirm('Annuler cette commande ?');">
        <input type="hidden" name="_token" value="{{ csrf_token('annuler' ~ c.id) }}">
        <button type="submit" class="action-btn action-cancel" title="Annuler">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </form>
    {% endif %}

  </div>
</td>


        </tr>
    {% else %}
        <tr>
            <td colspan="5" class="text-center text-muted">Aucune commande pour l’instant</td>
        </tr>
    {% endfor %}
    </tbody>
</table>

{# pagination #}
{% if pages > 1 %}
  <nav aria-label="Pagination commandes">
    <ul class="pagination mt-3">
      <li class="page-item {{ page == 1 ? 'disabled' : '' }}">
        <a class="page-link" href="{{ path('app_commande_achat_index', {page: page - 1}) }}">Précédent</a>
      </li>

      {% for i in 1..pages %}
        <li class="page-item {{ i == page ? 'active' : '' }}">
          <a class="page-link" href="{{ path('app_commande_achat_index', {page: i}) }}">{{ i }}</a>
        </li>
      {% endfor %}

      <li class="page-item {{ page == pages ? 'disabled' : '' }}">
        <a class="page-link" href="{{ path('app_commande_achat_index', {page: page + 1}) }}">Suivant</a>
      </li>
    </ul>
  </nav>
{% endif %}

{% endblock %}
