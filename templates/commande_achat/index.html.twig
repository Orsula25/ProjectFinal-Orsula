{% extends 'base.html.twig' %}

{% block titre %}Commandes d'achat{% endblock %}

{% block contenu %}

<h1>Commandes d'achat</h1>

<div class="mb-3">
    <a class="btn btn-sm btn-primary" href="{{ path('app_commande_achat_new') }}">
        ➕ Nouvelle commande
    </a>
</div>

<table class="table table-striped align-middle">
    <thead>
        <tr>
            <th>Référence</th>
            <th>Fournisseur</th>
            <th>Date</th>
            <th>Statut</th>
            <th style="width:220px;">Actions</th>
        </tr>
    </thead>
    <tbody>
    {% for c in commandes %}
        <tr>
            <td>{{ c.reference }}</td>
            <td>{{ c.fournisseur.nom }}</td>
            <td>{{ c.date ? c.date|date('d/m/Y H:i') : '—' }}</td>
            <td>
                {% if c.isBrouillon %}
                    <span class="badge bg-secondary">Brouillon</span>
                {% elseif c.isEnvoyee %}
                    <span class="badge bg-info text-dark">Envoyée</span>
                {% elseif c.isReceptionnee %}
                    <span class="badge bg-success">Réceptionnée</span>
                {% elseif c.isAnnulee %}
                    <span class="badge bg-danger">Annulée</span>
                {% else %}
                    <span class="badge bg-light text-dark">{{ c.statut }}</span>
                {% endif %}
            </td>
            <td class="d-flex flex-wrap gap-1">

                {# Voir détail #}
                <a class="btn btn-sm btn-outline-secondary"
                   href="{{ path('app_commande_achat_show', {id: c.id}) }}">
                    Voir
                </a>

                {# Envoyer si brouillon #}
                {% if c.isBrouillon %}
                    <form method="post"
                          action="{{ path('app_commande_achat_envoyer', {id: c.id}) }}"
                          onsubmit="return confirm('Envoyer cette commande au fournisseur ?');">
                        <input type="hidden" name="_token" value="{{ csrf_token('envoyer' ~ c.id) }}">
                        <button class="btn btn-sm btn-primary">Envoyer</button>
                    </form>
                {% endif %}

                {# Réceptionner si envoyée #}
                {% if c.isEnvoyee %}
                    <form method="post"
                          action="{{ path('app_commande_achat_reception', {id: c.id}) }}"
                          onsubmit="return confirm('Confirmer la réception ? Le stock va être ajouté.');">
                        <input type="hidden" name="_token" value="{{ csrf_token('reception' ~ c.id) }}">
                        <button class="btn btn-sm btn-success">Réceptionner</button>
                    </form>
                {% endif %}

                {# Annuler si brouillon OU envoyée (mais pas déjà réceptionnée) #}
                {% if (c.isBrouillon or c.isEnvoyee) and not c.isReceptionnee %}
                    <form method="post"
                          action="{{ path('app_commande_achat_annuler', {id: c.id}) }}"
                          onsubmit="return confirm('Annuler cette commande ?');">
                        <input type="hidden" name="_token" value="{{ csrf_token('annuler' ~ c.id) }}">
                        <button class="btn btn-sm btn-outline-danger">Annuler</button>
                    </form>
                {% endif %}

            </td>
        </tr>
    {% else %}
        <tr>
            <td colspan="5" class="text-center text-muted">Aucune commande pour l’instant</td>
        </tr>
    {% endfor %}
    </tbody>
</table>

{% endblock %}
