{% extends 'base.html.twig' %}

{% block titre %}Ajouter un achat — Logix G-Stock{% endblock %}

{% block contenu %}


<h1>Ajouter un achat</h1>

{{ form_start(form) }}
{{ form_widget(form.dateAchat) }}
{{ form_widget(form.etat) }}

{{ form_widget(form.fournisseur) }}

    <h3>Produits achetés</h3>

<ul class="detailAchats list-unstyled"
    data-index="{{ form.detailAchats|length }}"
    data-prototype="{{ form_widget(form.detailAchats.vars.prototype)|e('html_attr') }}">
  {% for detailForm in form.detailAchats %}
    <li class="mb-3">
      {{ form_row(detailForm) }}
    </li>
  {% endfor %}
</ul>

<div class="mt-3 d-flex gap-2">
  <button type="button" class="btn btn-outline-secondary add_item_link" data-collection-holder-class="detailAchats">➕</button>
  <button type="submit" class="btn btn-success">Ajouter</button>
</div>




{{ form_end(form)}}

<a class="btn btn-link mt-2" href="{{ path('app_achat_index') }}">Retour à la liste</a>


<script>
  // --- Met à jour le prix unitaire (20% de moins) à partir du produit choisi ---
  function updatePrixFromSelectedOption(selectEl) {
    // option sélectionnée
    const option = selectEl.options[selectEl.selectedIndex];
    // prix du produit dans data-prix
    const prix = option ? option.getAttribute('data-prix') : null;

    // input du prix dans le même <li>
    const prixInput = selectEl.closest('li')?.querySelector('input[name$="[prixUnitaire]"]');

    if (prixInput) {
      if (prix) {
        const prixUnitaire = parseFloat(prix);
        const prixAchat = prixUnitaire * 0.8; // 20% de moins

        prixInput.value = prixAchat.toFixed(2);
      } else {
        prixInput.value = '';
      }
    }
  }

  // --- Ajoute l'écouteur sur le <select> produit ---
  function attachProduitChangeListener(container) {
    container.querySelectorAll('select[name$="[produit]"]').forEach(function (selectEl) {
      if (!selectEl.dataset.listenerAttached) {
        selectEl.addEventListener('change', function () {
          updatePrixFromSelectedOption(selectEl);
        });

        // initialise le prix si un produit est déjà sélectionné
        updatePrixFromSelectedOption(selectEl);

        selectEl.dataset.listenerAttached = '1';
      }
    });
  }

  // --- Ajoute une nouvelle ligne de détail ---
  function addFormToCollection(e) {
    const collectionHolder = document.querySelector('.' + e.currentTarget.dataset.collectionHolderClass);
    const item = document.createElement('li');

    item.classList.add('mb-3');
    item.innerHTML = collectionHolder.dataset.prototype.replace(/__name__/g, collectionHolder.dataset.index);
    collectionHolder.appendChild(item);
    collectionHolder.dataset.index++;

    // bouton supprimer
    addDetailFormDeleteLink(item);
    // écouteur pour le prix
    attachProduitChangeListener(item);
  }

  // --- Ajoute le bouton "-" pour supprimer la ligne ---
  function addDetailFormDeleteLink(item) {
    const removeFormButton = document.createElement('button');
    removeFormButton.type = 'button';
    removeFormButton.textContent = '−';          // le petit "moins"
    removeFormButton.title = 'Supprimer la ligne';
    removeFormButton.classList.add('btn-remove-detail');
    item.append(removeFormButton);

    removeFormButton.addEventListener('click', (e) => {
      e.preventDefault();
      item.remove();
    });
  }

  // --- branche les boutons "+" existants ---
  document.querySelectorAll('.add_item_link').forEach(btn => {
    btn.addEventListener('click', addFormToCollection);
  });

  // --- pour les lignes déjà présentes au chargement ---
  document.querySelectorAll('ul.detailAchats li').forEach(tag => {
    addDetailFormDeleteLink(tag);
    attachProduitChangeListener(tag);
  });
</script>

{% endblock %}

    
